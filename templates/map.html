{% extends "base.html" %} {% block title %}Property Map{% endblock %} {% block
content %}
<h2>Interactive Property Map</h2>
<p>
  {% if properties_for_map %} Showing
  <strong>{{ properties_for_map | length }}</strong> properties on the map.
  Click on a marker for details. {% else %} No properties to display. Try
  performing a search on the 'Compare' page first. {% endif %}
</p>

<!-- This is the container where the map will be rendered -->
<div
  id="map"
  style="
    height: 600px;
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  "
></div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // --- 1. Initialize the Map ---
      // Set the map's center to Perth and choose a zoom level.
      const map = L.map('map').setView([-31.9523, 115.8605], 11);

      // --- 2. Add the Tile Layer (the map background) ---
      // We're using OpenStreetMap, a free and open map provider.
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // --- 3. Get the property data from our Flask backend ---
      // The 'tojson' filter safely converts the Python list to a JavaScript array.
      const properties = {{ properties_for_map | tojson | safe }};

      // --- 4. Add Markers for Each Property ---
      if (properties && properties.length > 0) {
          console.log(`Adding ${properties.length} markers to the map.`);

          // Create a feature group to hold all markers, which helps in fitting them to the view.
          const markerGroup = L.featureGroup();

          properties.forEach(function(prop) {
              // Check if latitude and longitude are valid numbers.
              if (typeof prop.latitude === 'number' && typeof prop.longitude === 'number') {
                  // Create a marker at the property's coordinates.
                  const marker = L.marker([prop.latitude, prop.longitude]);

                  // Create the popup content with basic property info.
                  const popupContent = `
                      <b>${prop.address}</b><br>
                      ${prop.suburb_name}<br>
                      Price: $${new Intl.NumberFormat().format(prop.price)}
                  `;

                  // Bind the popup to the marker.
                  marker.bindPopup(popupContent);

                  // Add the marker to our group.
                  markerGroup.addLayer(marker);
              }
          });

          // Add the entire group of markers to the map.
          markerGroup.addTo(map);

          // --- 5. Fit the Map to the Markers ---
          // This automatically adjusts the map's zoom and center to show all markers.
          if (markerGroup.getLayers().length > 0) {
               map.fitBounds(markerGroup.getBounds().pad(0.1));
          }
      }
  });
</script>
{% endblock %}
