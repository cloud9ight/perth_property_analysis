{% extends "base.html" %} {% block title %}Add New Record (Mock Mode){% endblock
%} {% block content %}
<h2>Add a New Property Sale Record (Mock Mode)</h2>
<p>
  <strong>Note:</strong> You are in 'Mock Mode'. Submitted records will be shown
  temporarily on this page but will NOT be saved to the real database.
</p>

<!-- The main data entry form -->
<form id="addRecordForm" action="{{ url_for('add_new_record') }}" method="post">
  <label for="listing_id">Listing ID:</label>
  <input
    type="number"
    id="listing_id"
    name="listing_id"
    placeholder="e.g., 12345678"
    required
  />

  <label for="price">Price:</label>
  <input
    type="number"
    id="price"
    name="price"
    placeholder="e.g., 650000"
    step="1"
    required
  />

  <label for="address">Address:</label>
  <input
    type="text"
    id="address"
    name="address"
    placeholder="e.g., 123 Hay Street"
    required
  />

  <label for="property_type">Property Type:</label>
  <select id="property_type" name="property_type">
    <option value="house">House</option>
    <option value="unit">Unit</option>
    <option value="villa">Villa</option>
    <option value="townhouse">Townhouse</option>
  </select>

  <label for="date_sold">Date Sold:</label>
  <input type="date" id="date_sold" name="date_sold" required />

  <label for="land_size">Land Size (sqm):</label>
  <input
    type="number"
    id="land_size"
    name="land_size"
    placeholder="e.g., 700"
  />

  <label for="parking_spaces">Parking Spaces:</label>
  <input
    type="number"
    id="parking_spaces"
    name="parking_spaces"
    placeholder="e.g., 2"
  />

  <!-- Dynamic Dropdown for Suburb -->
  <label for="suburb_select">Suburb:</label>
  <select id="suburb_select" name="suburb_id" required>
    <option value="">-- Select a Suburb --</option>
    {% for suburb in suburbs %}
    <option value="{{ suburb.suburb_id }}">
      {{ suburb.suburb_name | title }}
    </option>
    {% endfor %}
  </select>

  <!-- display the auto-filled postcode -->
  <label for="postcode_display">Postcode:</label>
  <input
    type="text"
    id="postcode_display"
    name="postcode_display"
    readonly
    placeholder="Auto-filled from address"
  />

  <!-- Dynamic Dropdown for Layout -->
  <label for="layout_id">Layout:</label>
  <select id="layout_id" name="layout_id" required>
    <option value="">-- Select a Layout --</option>
    {% for layout in layouts %}
    <option value="{{ layout.layout_id }}">{{ layout.layout_name }}</option>
    {% endfor %}
  </select>

  <!-- Dynamic Dropdown for Agency -->
  <label for="agency_id">Agency:</label>
  <select id="agency_id" name="agency_id" required>
    <option value="">-- Select an Agency --</option>
    {% for agency in agencies %}
    <option value="{{ agency.agency_id }}">
      {{ agency.agency_name | title }}
    </option>
    {% endfor %}
  </select>

  <!-- Dynamic Dropdown for Primary School -->
  <label for="primary_school_id">Primary School:</label>
  <select id="primary_school_id" name="primary_school_id" required>
    <option value="">-- Select a Primary School --</option>
    {% for school in primary_schools %}
    <option value="{{ school.primary_school_id }}">
      {{ school.primary_school_name | title }}
    </option>
    {% endfor %}
  </select>

  <!-- Dynamic Dropdown for Secondary School -->
  <label for="secondary_school_id">Secondary School:</label>
  <select id="secondary_school_id" name="secondary_school_id" required>
    <option value="">-- Select a Secondary School --</option>
    {% for school in secondary_schools %}
    <option value="{{ school.secondary_school_id }}">
      {{ school.secondary_school_name | title }}
    </option>
    {% endfor %}
  </select>

  <input type="hidden" id="suburb_name_text" name="suburb_name_text" />
  <input type="hidden" id="layout_name_text" name="layout_name_text" />

  <button type="submit">Simulate Adding Record</button>
</form>

<hr style="margin: 2em 0" />

<!-- section to display the "fake" database -->
<div class="results">
  <h3>Temporarily Added Records (Resets on Server Restart)</h3>
  {% if records %}
  <table style="width: 100%; border-collapse: collapse">
    <thead>
      <tr style="background-color: #e9ecef">
        <th>Listing ID</th>
        <th>Price</th>
        <th>Address</th>
        <th>Suburb</th>
        <th>Layout</th>
      </tr>
    </thead>
    <tbody>
      <!-- Loop through the list of records passed from the backend -->
      {% for record in records %}
      <tr>
        <td>{{ record.listing_id }}</td>
        <td>${{ "{:,.0f}".format(record.price) }}</td>
        <td>{{ record.address }}</td>
        <td>{{ record.suburb_name }}</td>
        <td>{{ record.layout_name }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No records have been added yet during this session.</p>
  {% endif %}
</div>

{% endblock %} {% block scripts %}
<script>
  function initAutocomplete() {
    const addressInput = document.getElementById("address");
    const suburbSelect = document.getElementById("suburb_select");
    const postcodeDisplay = document.getElementById("postcode_display");
    if (!addressInput || !suburbSelect || !postcodeDisplay) {
      console.error(
        "Critical Error: One or more form elements could not be found for Autocomplete."
      );
      return;
    }
    const autocomplete = new google.maps.places.Autocomplete(addressInput, {
      componentRestrictions: { country: "au" },
      fields: ["address_components", "formatted_address"],
      types: ["address"],
    });
    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.address_components) {
        return;
      }
      let suburbName = "";
      let postcodeValue = "";
      for (const component of place.address_components) {
        const componentType = component.types[0];
        if (componentType === "locality") {
          suburbName = component.long_name.toLowerCase();
        }
        if (componentType === "postal_code") {
          postcodeValue = component.long_name;
        }
      }
      postcodeDisplay.value = postcodeValue;
      let foundSuburb = false;
      for (let i = 0; i < suburbSelect.options.length; i++) {
        const option = suburbSelect.options[i];
        if (option.text.toLowerCase() === suburbName) {
          option.selected = true;
          foundSuburb = true;
          break;
        }
      }
      if (!foundSuburb) {
        suburbSelect.selectedIndex = 0;
        console.warn(
          `Could not find a match for suburb "${suburbName}" in the dropdown.`
        );
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("addRecordForm");
    if (form) {
      form.addEventListener("submit", function (event) {
        console.log(
          "FRONTEND V5 - Submit event fired! Capturing dropdown text..."
        );
        try {
          const suburbSelect = document.getElementById("suburb_select");
          const selectedSuburbText =
            suburbSelect.options[suburbSelect.selectedIndex].text;
          const layoutSelect = document.getElementById("layout_id");
          const selectedLayoutText =
            layoutSelect.options[layoutSelect.selectedIndex].text;
          document.getElementById("suburb_name_text").value =
            selectedSuburbText;
          document.getElementById("layout_name_text").value =
            selectedLayoutText;
          console.log("FRONTEND V5 - Successfully set hidden fields:", {
            suburb: selectedSuburbText,
            layout: selectedLayoutText,
          });
        } catch (error) {
          console.error("Error capturing dropdown text on submit:", error);
        }
      });
    } else {
      console.error(
        "Critical Error: Could not find form with ID 'addRecordForm'."
      );
    }
  });
</script>

<!-- The Google Maps script loader -->
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key | safe }}&libraries=places&callback=initAutocomplete"
  defer
></script>
{% endblock %}
