{% extends "base.html" %}

{% block title %}Explore Property Data{% endblock %}

{% block content %}
    <h2>Explore Perth Property Data</h2>
    <p>Use the filters below to query the real database. Displays a statistical summary and lists sold properties descending.</p>

    <div class="filter-container">
    <!-- Filter Form -->
    <form class="filter-form" action="{{ url_for('explore') }}" method="post">
         <div class="filter-group">
        
        <label for="year_select">Year:</label>
        <select id="year_select" name="year_select">
            <option value="">-- All Years --</option>
            {% for year in available_years %}
                <option value="{{ year }}" {% if year == selected_filters.year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
      </div>

        <div class="filter-group">
        <label for="suburb_select">Suburb:</label>
        <select id="suburb_select" name="suburb_select">
            <option value="">-- All Suburbs --</option>
            {% for suburb in available_suburbs %}
                 <option value="{{ suburb.suburb_id }}" {% if suburb.suburb_id == selected_filters.suburb_id %}selected{% endif %}>
                    {{ suburb.suburb_name | title }}
                </option>
            {% endfor %}
        </select>
        </div>

        <div class="filter-group">
        <label for="layout_select">Layout:</label>
        <select id="layout_select" name="layout_select">
            <option value="">-- All Layouts --</option>
            {% for layout in available_layouts %}
                <option value="{{ layout.layout_id }}" {% if layout.layout_id == selected_filters.layout_id %}selected{% endif %}>
                    {{ layout.layout_name }}
                </option>
            {% endfor %}
        </select>
        </div>

        <button type="submit">Apply Filters</button>
    </form>
  </div>

    <hr style="margin: 2em 0;">

    <!-- Results Section -->

     <div class="summary">
        <h3>Statistical Summary</h3>
        <!-- Only show this section if the 'stats_summary' dictionary exists -->
        {% if stats_summary %}
            <div class="summary-grid">
                <div class="summary-box">
                    <h4>Market Overview</h4>
                    <p><strong>Total Sales Found:</strong> {{ stats_summary.total_sales }}</p>
                    <p><strong>Average Price:</strong> ${{ "{:,.0f}".format(stats_summary.avg_price) }}</p>
                    <p><strong>Median Price:</strong> ${{ "{:,.0f}".format(stats_summary.median_price) }}</p>
                </div>
                <div class="summary-box">
                    <h4>Most Expensive Sale</h4>
                    <p><strong>Price:</strong> ${{ "{:,.0f}".format(stats_summary.max_price) }}</p>
                    <p><strong>Address:</strong> {{ stats_summary.max_price_address }}</p>
                    <p><strong>Date:</strong> {{ stats_summary.max_price_date.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Land Size:</strong> {{ stats_summary.max_price_land_size }} sqm</p>
                </div>
                <div class="summary-box">
                    <h4>Least Expensive Sale</h4>
                    <p><strong>Price:</strong> ${{ "{:,.0f}".format(stats_summary.min_price) }}</p>
                    <p><strong>Address:</strong> {{ stats_summary.min_price_address }}</p>
                    <p><strong>Date:</strong> {{ stats_summary.min_price_date.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Land Size:</strong> {{ stats_summary.min_price_land_size }} sqm</p>
                </div>
            </div>
        {% elif request.method == 'POST' %}
            <p>No statistical summary could be generated for the selected criteria.</p>
        {% endif %}
    </div>
    <div class="results">
        <h3>Query Results</h3>
        <div style="margin-bottom: 1.5em">
    <a
      href="{{ url_for('show_map', ids=stats_results | map(attribute='listing_id') | join(',')) }}"
      class="button-link"
    >
      View these properties on a map
    </a>
  </div>
        <!-- Only show the table if the 'results' list is not empty -->
        {% if results_list %}
            <p>Found <strong>{{ results_list | length }}</strong> matching records.</p>
            <table>
                <thead>
                    <tr>
                        <!-- Dynamically create table headers from the keys of the first result dictionary -->
                        {% for key in results_list[0].keys() %}
                            <th>{{ key.replace('_', ' ') | title }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in results_list %}
                        <tr>
                            <!-- Loop through each value in the row dictionary -->
                            {% for value in row.values() %}
                                <td>
                                    <!-- A small trick to format price nicely -->
                                    {% if loop.first %}
                                        ${{ "{:,.0f}".format(value) }}
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif request.method == 'POST' %}
            <!-- Show this message only if a query was run but found nothing -->
            <p>No records found matching your selected criteria.</p>
        {% else %}
             <!-- Show this message on initial page load -->
            <p>Please apply filters and click "Apply Filters" to see results.</p>
        {% endif %}
    </div>

{% endblock %}

{% block scripts %}
    <!-- We can add Chart.js here in the future for visualization -->
{% endblock %}