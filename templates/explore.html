{% extends "base.html" %}

{% block title %}Explore Property Data{% endblock %}

{% block content %}
    <h2>Explore Perth Property Data</h2>
    <p>Use the filters below to query the database and find insights. Results are limited to the most expensive properties matching your criteria.</p>

    <!-- Filter Form -->
    <form action="{{ url_for('explore') }}" method="post">
        <h3>Filters</h3>
        
        <label for="year_select">Year:</label>
        <select id="year_select" name="year_select">
            <option value="">-- All Years --</option>
            {% for year in available_years %}
                <option value="{{ year }}" {% if year == selected_filters.year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <label for="suburb_select">Suburb:</label>
        <select id="suburb_select" name="suburb_select">
            <option value="">-- All Suburbs --</option>
            {% for suburb in available_suburbs %}
                 <option value="{{ suburb.suburb_id }}" {% if suburb.suburb_id == selected_filters.suburb_id %}selected{% endif %}>
                    {{ suburb.suburb_name | title }}
                </option>
            {% endfor %}
        </select>

        <label for="layout_select">Layout:</label>
        <select id="layout_select" name="layout_select">
            <option value="">-- All Layouts --</option>
            {% for layout in available_layouts %}
                <option value="{{ layout.layout_id }}" {% if layout.layout_id == selected_filters.layout_id %}selected{% endif %}>
                    {{ layout.layout_name }}
                </option>
            {% endfor %}
        </select>

        <button type="submit">Apply Filters</button>
    </form>

    <hr style="margin: 2em 0;">

    <!-- Results Section -->
    <div class="results">
        <h3>Query Results</h3>
        <!-- Only show the table if the 'results' list is not empty -->
        {% if results %}
            <p>Found <strong>{{ results | length }}</strong> matching records.</p>
            <table>
                <thead>
                    <tr>
                        <!-- Dynamically create table headers from the keys of the first result dictionary -->
                        {% for key in results[0].keys() %}
                            <th>{{ key.replace('_', ' ') | title }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                        <tr>
                            <!-- Loop through each value in the row dictionary -->
                            {% for value in row.values() %}
                                <td>
                                    <!-- A small trick to format price nicely -->
                                    {% if loop.first %}
                                        ${{ "{:,.0f}".format(value) }}
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif request.method == 'POST' %}
            <!-- Show this message only if a query was run but found nothing -->
            <p>No records found matching your selected criteria.</p>
        {% else %}
             <!-- Show this message on initial page load -->
            <p>Please apply filters and click "Apply Filters" to see results.</p>
        {% endif %}
    </div>

{% endblock %}

{% block scripts %}
    <!-- We can add Chart.js here in the future for visualization -->
{% endblock %}